---
title: "Westchester municipalities"
site: distill::distill_website
preview: img/wch-map.png
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
mun_recent <- mun_cases %>% 
  filter(date == max(date), municipality != "Totals") %>%
  mutate(new_cases_day_avg = active_cases / 14)

mun_cases_poly <- mun_bound %>% 
  left_join(mun_recent, by = "municipality") %>% 
  mutate(
    new_cases_per_cap = new_cases_day_avg / total_pop * 1e5,
    total_cases_per_cap = total_cases / total_pop
    ) %>% 
  arrange(desc(new_cases_per_cap))

tot_cases_least <- mun_cases_poly %>% 
  arrange(total_cases_per_cap)

tot_cases_most <- mun_cases_poly %>% 
  arrange(desc(total_cases_per_cap))
```

***The Westchester County Department of Health has not released updated case data by municipality since `r month_day_year(max(mun_recent$date), abbr = TRUE)`, so the information presented here may not reflect the current state of the pandemic in Westchester municipalities.***

On Dec 18, 2020, the County government tweeted that they are pausing the release of municipal-level data:

<a href="https://twitter.com/westchestergov/status/1340044992023318534"><img src="img/westchester-gov-tweet.png" alt="@westchestergov tweet" style="width:80%"></a>

The municipality with the most new cases per capita in the past 14 days is **`r mun_cases_poly$municipality[1]`**, where there have been `r comma(mun_cases_poly$active_cases[1], 1)` cases reported between `r month_day_year(max(mun_recent$date) - days(14), abbr = TRUE)` and `r month_day_year(max(mun_recent$date), abbr = TRUE)`  (`r comma(mun_cases_poly$new_cases_per_cap[1] * 14, 1)` per 100,000 residents). **`r mun_cases_poly$municipality[2]`** is another recent hot spot, with `r comma(mun_cases_poly$active_cases[2], 1)` cases reported in the last two weeks (`r comma(mun_cases_poly$new_cases_per_cap[2] * 14, 1)` per 100,000). 

Throughout the pandemic, the municipalities that have had the largest share of their population test positive for coronavirus are **`r tot_cases_most$municipality[1]`** (`r pretty_frac(tot_cases_most$total_cases_per_cap[1])`) and **`r tot_cases_most$municipality[2]`** (`r pretty_frac(tot_cases_most$total_cases_per_cap[2])`). The municipalities that have had the fewest cases per capita are **`r tot_cases_least$municipality[1]`** (`r pretty_frac(tot_cases_least$total_cases_per_cap[1])`) and **`r tot_cases_least$municipality[2]`** (`r pretty_frac(tot_cases_least$total_cases_per_cap[2])`).

### New cases per capita (14-day average)

```{r mun_per_capita_map, out.height="600px", out.width="600px"}
mun_cases_centroid <- mun_cases_poly %>% 
  st_centroid()

to_map <- mun_cases_poly %>% 
  st_transform(4326) %>% 
  mutate(
    label = paste0(
      "<b>", municipality, "</b><br>",
      "Avg. daily cases: ", comma(new_cases_day_avg, 0.1), "<br>",
      "Per 100k: ", number(new_cases_per_cap, 0.1)
      )
    )

to_map_total <- mun_cases_centroid %>% 
  st_transform(4326) %>% 
  mutate(
    label = paste0(
      "<b>", municipality, "</b><br>",
      "Total cases: ", comma(total_cases, 1), "<br>",
      "Share of population: ", pretty_frac(total_cases_per_cap)
      )
    )

cd_pal <- colorNumeric(
  palette = "YlOrRd",
  domain = 0:100
  )

leaflet(to_map) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    group = "Cases per 100k",
    weight = 1.5,
    color = "white",
    fillColor = ~cd_pal(new_cases_per_cap),
    fillOpacity = 0.8,
    label = lapply(to_map$label, htmltools::HTML),
    highlight = highlightOptions(
      weight = 2,
      color = "#666666",
      opacity = 0.7,
      fillOpacity = 0.7,
      bringToFront = TRUE
      )
    ) %>%
  addCircles(
    data = to_map_total,
    group = "Total cases",
    radius = ~ sqrt(total_cases) * 50,
    color = "steelblue",
    opacity = 0.7,
    weight = 1.5,
    fillColor = "steelblue",
    fillOpacity = 0.2,
    label = lapply(to_map_total$label, htmltools::HTML)
    ) %>% 
  addLegend(
    group = "Cases per 100k",
    pal = cd_pal,
    values = 0:100,
    opacity = 0.7,
    bins = c(0, 25, 50, 75, 100),
    position = "bottomright",
    title = "Avg. daily cases per 100k<br>in past 14 days"
    ) %>% 
  addLayersControl(
    baseGroups = c("Cases per 100k", "Total cases"),
    options = layersControlOptions(collapsed = FALSE)
   ) %>% 
  setView(lat = 41.1, lng = -73.75, zoom = 10) %>% 
  addResetMapButton()
```

<br>

```{r town-table, layout="l-body-outset", out.height="510px"}
mun_cases_poly %>% 
  st_drop_geometry() %>% 
  arrange(desc(new_cases_per_cap)) %>% 
  mutate(total_cases_per_cap = pretty_frac(total_cases_per_cap)) %>% 
  select(
    `Municipality` = municipality,
    `Avg daily cases per 100k` = new_cases_per_cap,
    `Avg daily cases` = new_cases_day_avg,
    `Total cases` = total_cases,
    `Share of pop` = total_cases_per_cap,
    `Total pop` = total_pop
    ) %>% 
  datatable(
    class = "compact hover",
    extensions = c("Scroller", "Responsive"),
    caption = tags$caption(
      style = 'caption-side: bottom; text-align: right;',
      withTags(div(HTML('Source: <a href="https://westchester-covid.mattherman.info/about#covid-19-confirmed-cases" target="_self">Westchester County DOH</a>')))
    ),
    options = list(
      dom = "ft",
      deferRender = TRUE,
      scrollY = 250,
      scroller = TRUE,
      columnDefs = list(
        list(visible = FALSE, targets = 0),
        list(className = "dt-head-left", targets = 1),
        list(className = "dt-center", targets = 5)
        )
      )
    ) %>% 
  formatRound(2:3, digits = 1) %>% 
  formatRound(c(4, 6), digits = 0) %>% 
  formatStyle(1, fontFamily = "IBM Plex Sans") %>% 
  formatStyle(2:6, fontFamily = "Roboto Mono")
```

<br>
<br>

```{r mun_heat_map, layout="l-page", out.height="700px"}
all_dates <- seq(min(mun_cases$date), max(mun_cases$date), by = "1 day")
all_mun <- mun_bound$municipality

all_days_mun <- crossing(date = all_dates, municipality = all_mun) %>% 
  left_join(mun_cases, by = c("date", "municipality")) %>% 
  left_join(st_drop_geometry(mun_bound), by = "municipality") %>% 
  mutate(active_per_cap = active_cases / total_pop) %>% 
  group_by(municipality) %>% 
  fill(active_per_cap, c(total_cases:active_per_cap)) %>%
  ungroup()
  
p <- all_days_mun %>%  
  filter(!is.na(active_per_cap), active_per_cap < 0.03) %>% 
  mutate(municipality = fct_reorder(municipality, active_per_cap, mean)) %>% 
  ggplot(aes(date, municipality, fill = active_per_cap)) +
  geom_tile(
    aes(
      text = paste0(
        "<b>", municipality, " - ", month_day_year(date, abbr = TRUE), "</b><br>",
        "Avg. daily cases: ", comma(active_cases / 14, 0.1), "<br>",
        "Per 100k: ", comma(active_per_cap / 14 * 1e5, 0.1)
      ))) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +
  scale_x_date(

    labels = label_date_short(),
    breaks = "1 month",
    expand = expansion(mult = c(0.01, 0))
    ) +
  labs(x = NULL, y = NULL) +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid = element_blank()
    )

ggplotly_config(p)
```
